name: Delete smonthl-api Package and Self-Destruct

on:
  schedule:
    # Run 25 hours after the workflow was created (to ensure 24 hours have passed)
    # This will run at 09:00 UTC on February 2, 2026 (25 hours after package was published)
    - cron: '0 9 2 2 *'  # minute hour day month day-of-week
  workflow_dispatch:  # Allow manual trigger for testing

jobs:
  delete-package-and-workflow:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://npm.pkg.github.com'
          scope: '@moude-ai'

      - name: Wait to ensure 24 hours have passed
        run: |
          echo "Waiting to ensure 24 hours have passed since package publication..."
          echo "Current time: $(date)"
          sleep 60  # Wait 1 minute to be safe

      - name: Delete @moude-ai/smonthl-api package
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Attempting to delete @moude-ai/smonthl-api@2.0.7..."
          
          # Try to unpublish the package
          npm unpublish @moude-ai/smonthl-api@2.0.7 --force --registry=https://npm.pkg.github.com || {
            echo "Failed to unpublish package. It may have already been deleted or 24 hours haven't passed yet."
            exit 0
          }
          
          echo "‚úÖ Package @moude-ai/smonthl-api@2.0.7 deleted successfully!"

      - name: Verify package deletion
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Verifying package deletion..."
          
          # Check if package still exists
          if npm view @moude-ai/smonthl-api@2.0.7 --registry=https://npm.pkg.github.com 2>/dev/null; then
            echo "‚ö†Ô∏è Package still exists. Deletion may have failed."
            exit 1
          else
            echo "‚úÖ Confirmed: Package has been deleted!"
          fi

      - name: Delete this workflow file
        run: |
          echo "Package deleted successfully. Now deleting this workflow file..."
          
          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Delete the workflow file
          git rm .github/workflows/delete-smonthl-api-package.yml
          
          # Commit and push
          git commit -m "üóëÔ∏è Auto-delete: Remove smonthl-api package cleanup workflow (task completed)"
          git push
          
          echo "‚úÖ Workflow file deleted. This workflow will not run again."

      - name: Summary
        run: |
          echo "================================================"
          echo "‚úÖ Cleanup Complete!"
          echo "================================================"
          echo "1. ‚úÖ Package @moude-ai/smonthl-api@2.0.7 deleted"
          echo "2. ‚úÖ Workflow file deleted"
          echo "3. ‚úÖ This workflow will never run again"
          echo "================================================"
          echo ""
          echo "Remaining packages:"
          echo "  - @moude-ai/smonthl@2.0.8 (HTML version)"
          echo "  - @moude-ai/smonthl-react@2.0.8 (React version)"
          echo "================================================"
